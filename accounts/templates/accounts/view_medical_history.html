{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Medical History - Medilink</title>
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
  <style>
    :root{ --sidebar-w:260px; --transition:.25s ease; }
    html,body{ height:100%; margin:0; background:#f8fafc; }
    .app{ height:100vh; width:100vw; display:grid; grid-template-columns:var(--sidebar-w) 1fr; transition:var(--transition); overflow:hidden; }
    .app.is-collapsed{ grid-template-columns:72px 1fr; }
    .sidebar{ background:#fff; border-right:1px solid var(--line); display:flex; flex-direction:column; overflow:hidden; transition:var(--transition); }
    .brand{ display:flex; align-items:center; gap:.6rem; padding:1rem; border-bottom:1px solid var(--line); }
    .brand .logo{ width:36px; height:36px; border-radius:10px; display:grid; place-items:center; background:linear-gradient(135deg,var(--brand1),var(--brand2)); color:#fff; font-weight:800; }
    .brand h1{ font-size:1.05rem; margin:0; letter-spacing:.2px; }
    .side-section{ padding:.75rem 1rem; }
    .side-title{ font-size:.8rem; font-weight:800; color:var(--ink-dim); margin:.4rem 0 .3rem; }
    .nav{ display:flex; flex-direction:column; gap:.4rem; }
    .nav a{ display:flex; align-items:center; gap:.55rem; padding:.7rem .6rem; border-radius:10px; color:var(--ink); text-decoration:none; border:1px solid transparent; transition:.15s; }
    .nav a:hover{ background:#f1f5f9; border-color:var(--line); }
    .nav a.active{ background:linear-gradient(135deg,var(--brand1),var(--brand2)); color:#fff; }
    .collapse-btn{ border-top:1px solid var(--line); padding:.6rem 1rem; margin-top:auto; }
    .collapse-btn button{ width:100%; border:1px solid var(--line); background:#fff; color:var(--ink); padding:.6rem; border-radius:10px; cursor:pointer; font-weight:700; }
    .app.is-collapsed .brand h1, .app.is-collapsed .side-title, .app.is-collapsed .nav a span.label{ display:none; }
    .app.is-collapsed .nav a{ justify-content:center; }

    .main{ display:grid; grid-template-rows:auto 1fr; height:100%; overflow:hidden; }
    .topbar{ background:#fff; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; gap:1rem; padding:.75rem 1rem; }
    .top-left{ display:flex; align-items:center; gap:1rem; }
    .hamburger{ display:none; width:38px; height:38px; border-radius:10px; border:1px solid var(--line); background:#fff; cursor:pointer; }
    .top-title{ font-weight:800; font-size:1.05rem; }
    .top-right{ display:flex; align-items:center; gap:.9rem; }
    .avatar{ width:36px; height:36px; border-radius:999px; display:grid; place-items:center; color:#fff; background:linear-gradient(135deg,var(--brand1),var(--brand2)); font-weight:800; }
    .btn-ghost{ border:1px solid var(--line); background:#fff; color:var(--ink); padding:.45rem .7rem; border-radius:10px; cursor:pointer; font-weight:700; transition:background .2s ease; }
    .btn-ghost:hover{ background:#f1f5f9; }

    .content{ padding:1.5rem; height:100%; overflow-y:auto; background:#f8fafc; }
    .page-header{ margin-bottom:1.5rem; }
    .page-header h1{ font-size:1.75rem; font-weight:800; margin-bottom:.4rem; }
    .page-header p{ color:var(--ink-dim); }

    .info-grid{ display:grid; grid-template-columns:repeat(auto-fit, minmax(240px, 1fr)); gap:1rem; margin-bottom:1.5rem; }
    .info-card{ background:#fff; border:1px solid var(--line); border-radius:12px; padding:1rem; }
    .info-card .label{ font-size:.85rem; color:var(--ink-dim); font-weight:600; margin-bottom:.4rem; }
    .info-card .value{ font-size:1.1rem; font-weight:700; color:var(--ink); }

    .section{ background:#fff; border:1px solid var(--line); border-radius:12px; margin-bottom:1.5rem; }
    .section-header{ padding:1rem; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:between; }
    .section-header h2{ font-size:1.1rem; font-weight:800; margin:0; }
    .section-body{ padding:1rem; }

    .history-item{ border:1px solid var(--line); border-radius:10px; padding:1rem; margin-bottom:.8rem; transition:.15s; }
    .history-item:hover{ border-color:var(--brand2); box-shadow:0 0 0 3px var(--focus); }
    .history-date{ font-size:.85rem; color:var(--ink-dim); font-weight:700; margin-bottom:.5rem; }
    .history-doctor{ font-weight:700; color:var(--ink); margin-bottom:.3rem; }
    .history-notes{ color:var(--ink-dim); font-size:.9rem; }

    .test-results-grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:1rem; }
    .test-card{ border:1px solid var(--line); border-radius:10px; padding:1rem; text-align:center; transition:.15s; cursor:pointer; }
    .test-card:hover{ border-color:var(--brand2); transform:translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,.1); }
    .test-icon{ width:48px; height:48px; margin:0 auto 1rem; background:linear-gradient(135deg,rgba(14,165,164,.1),rgba(2,132,199,.1)); border-radius:10px; display:grid; place-items:center; }
    .test-name{ font-weight:700; font-size:.9rem; margin-bottom:.3rem; }
    .test-date{ font-size:.8rem; color:var(--ink-dim); }

    .empty-state{ text-align:center; padding:3rem 1rem; }
    .empty-state svg{ margin:0 auto 1rem; opacity:.3; }
    .empty-state p{ color:var(--ink-dim); margin:.5rem 0; }

    .summary-box{ background:linear-gradient(135deg,rgba(14,165,164,.05),rgba(2,132,199,.05)); border:1px solid var(--line); border-radius:12px; padding:1.5rem; margin-bottom:1.5rem; }
    .summary-box h3{ font-size:1rem; font-weight:800; margin-bottom:.75rem; }
    .summary-box p{ color:var(--ink-dim); line-height:1.6; }

    @media (max-width:1020px){ 
      .hamburger{ display:grid; } 
      .info-grid{ grid-template-columns:1fr; }
    }

    /* Editable field + button styles */
      .input-field {
        width: 100%;
        border: 1px solid var(--line);
        border-radius: 8px;
        padding: .5rem .6rem;
        font-size: .95rem;
        color: var(--ink);
        background: #fff;
        box-sizing: border-box;
      }
      .input-field:focus {
        outline: none;
        border-color: var(--brand2);
        box-shadow: 0 0 0 2px rgba(99,102,241,.2);
      }

      .save-btn {
        background: linear-gradient(135deg, var(--brand1), var(--brand2));
        color: #fff;
        font-weight: 700;
        border: none;
        padding: .7rem 1.3rem;
        border-radius: 10px;
        cursor: pointer;
        transition: .2s;
      }
      .save-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(99,102,241,.3);
      }




  </style>
</head>
<body>
  <div class="app" id="appShell">
    <aside class="sidebar">
      <div class="brand"><div class="logo">ML</div><h1>Medilink</h1></div>
      <div class="side-section">
        <div class="side-title">Quick Actions</div>
        <nav class="nav">
          <a href="{% url 'patient_home' %}">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2"></rect><line x1="3" y1="10" x2="21" y2="10"></line>
            </svg><span class="label">View Full Schedule</span>
          </a>
          <a href="{% url 'schedule_appointment' %}">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 5v14M5 12h14"></path>
            </svg><span class="label">Schedule Appointment</span>
          </a>
          <a href="{% url 'view_medical_history' %}" class="active">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"></path>
            </svg><span class="label">View Medical History</span>
          </a>
          <a href="{% url 'view_prescriptions' %}">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg><span class="label">View Prescriptions</span>
          </a>
          <a href="{% url 'browse_medicine' %}">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path>
            </svg><span class="label">Browse Medicine</span>
          </a>
        </nav>
      </div>
      <div class="collapse-btn"><button type="button" id="toggleBtn">Collapse Sidebar</button></div>
    </aside>

    <section class="main">
      <header class="topbar">
        <div class="top-left">
          <button class="hamburger" id="hamburger" aria-label="Toggle sidebar">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
          </button>
          <div class="top-title">Medical History</div>
        </div>
        <div class="top-right">
          <div class="avatar">{{ patient_name|first|upper }}</div>
          <div>
            <div style="font-weight:800;">{{ patient_name }}</div>
            <small style="color:var(--ink-dim);">{{ today }}</small>
          </div>
          <form action="{% url 'logout' %}" method="post" style="margin-left:.5rem;">
            {% csrf_token %}
            <button type="submit" class="btn-ghost">Sign out</button>
          </form>
        </div>
      </header>

      <div class="content">
        <div class="page-header">
          <h1>ðŸ“‹ Your Medical History</h1>
          <p>View your health information, past appointments, and test results</p>
        </div>

    
        <!-- Editable Patient Information -->
        <form method="post" class="info-grid" style="margin-bottom:1.5rem;">
          {% csrf_token %}
          <div class="info-card">
            <div class="label">National ID</div>
            <input type="text" name="national_id" value="{{ patient_info.national_id }}" class="input-field">
          </div>

          <div class="info-card">
            <div class="label">Date of Birth</div>
            <input type="date" name="dob" value="{{ patient_info.dob|date:'Y-m-d' }}" class="input-field">
          </div>

          <div class="info-card">
            <div class="label">Gender</div>
            <select name="gender" class="input-field">
              <option value="">Select</option>
              <option value="Male" {% if patient_info.gender == 'Male' %}selected{% endif %}>Male</option>
              <option value="Female" {% if patient_info.gender == 'Female' %}selected{% endif %}>Female</option>
              <option value="Other" {% if patient_info.gender == 'Other' %}selected{% endif %}>Other</option>
            </select>
          </div>

          <div class="info-card">
            <div class="label">Blood Type</div>
            <select name="blood_type" class="input-field">
              <option value="">Select</option>
              {% for type in blood_types %}
                <option value="{{ type }}" {% if patient_info.blood_type == type %}selected{% endif %}>{{ type }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="summary-box" style="grid-column:1 / -1;">
            <h3>Medical Summary</h3>
            <textarea name="history_summary" rows="4" class="input-field" placeholder="Enter your medical background...">{{ patient_info.history_summary }}</textarea>
          </div>

          <div style="grid-column:1 / -1; text-align:right;">
            <button type="submit" class="save-btn">ðŸ’¾ Save Changes</button>
          </div>
        </form>


      

        <!-- Past Appointments -->
        <div class="section">
          <div class="section-header">
            <h2>Past Appointments</h2>
          </div>
          <div class="section-body">
            {% if past_appointments %}
              {% for appt in past_appointments %}
                <div class="history-item">
                  <div class="history-date">{{ appt.date_time|date:"F d, Y - h:i A" }}</div>
                  <div class="history-doctor">{{ appt.doctor }}</div>
                  <div class="history-notes">{{ appt.doctor_notes|default:"No notes available" }}</div>
                </div>
              {% endfor %}
            {% else %}
              <div class="empty-state">
                <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"></path>
                </svg>
                <p>No past appointments recorded</p>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Test Results -->
        <div class="section">
          <div class="section-header">
            <h2>Test Results</h2>
          </div>
          <div class="section-body">
            {% if test_results %}
              <div class="test-results-grid">
                {% for result in test_results %}
                  <a href="{{ result.test_result.url }}" target="_blank" class="test-card">
                    <div class="test-icon">
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                      </svg>
                    </div>
                    <div class="test-name">Test Result #{{ forloop.counter }}</div>
                    <div class="test-date">Click to view</div>
                  </a>
                {% endfor %}
              </div>
            {% else %}
              <div class="empty-state">
                <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 11l3 3L22 4"></path>
                  <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                </svg>
                <p>No test results available</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    const app=document.getElementById('appShell');
    const btn=document.getElementById('toggleBtn');
    const burger=document.getElementById('hamburger');
    const toggle=()=>{
      app.classList.toggle('is-collapsed');
      btn.textContent=app.classList.contains('is-collapsed')?'Expand Sidebar':'Collapse Sidebar';
    };
    if(btn) btn.addEventListener('click',toggle);
    if(burger) burger.addEventListener('click',toggle);
  </script>
</body>
</html>